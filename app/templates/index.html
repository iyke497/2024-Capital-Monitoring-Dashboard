{% extends "layout.html" %}

{% block title %}Survey Dashboard{% endblock %}
{% block header %}Data Ingestion Dashboard{% endblock %}

{% block content %}
<div class="controls">
    <button class="button-primary" onclick="fetchData('survey1')">Fetch Survey 1</button>
    <button class="button-primary" onclick="fetchData('survey2')">Fetch Survey 2</button>
</div>

<div class="stats-cards">
    <div class="card"><h3>Total</h3><div id="total-responses" class="stat-val">0</div></div>
    <div class="card"><h3>Survey 1</h3><div id="survey1-count" class="stat-val">0</div></div>
    <div class="card"><h3>Survey 2</h3><div id="survey2-count" class="stat-val">0</div></div>
</div>

<table id="responses-table" class="display" style="width:100%">
    <thead>
        <tr>
            <th>Project Name</th>
            <th>ERGP Code</th>
            <th>MDA</th>
            <th>% Done</th>
            <th>Appropriation</th>
        </tr>
    </thead>
</table>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 1. Initialize DataTable
    const table = $('#responses-table').DataTable({
        serverSide: true,
        ajax: '/api/responses',
        columns: [
            { data: 'project_name', defaultContent: 'N/A' },
            { data: 'ergp_code', defaultContent: 'N/A' },
            { data: 'mda_name', defaultContent: 'N/A' },
            { data: 'percentage_completed', defaultContent: '0%' },
            { 
                data: 'project_appropriation_2024',
                render: $.fn.dataTable.render.number(',', '.', 2, 'â‚¦')
            }
        ]
    });

    // 2. Refresh Stats
    window.updateStats = function() {
        $.get('/api/stats', function(data) {
            $('#total-responses').text(data.total_responses);
            $('#survey1-count').text(data.survey1_count);
            $('#survey2-count').text(data.survey2_count);
        });
    };

    // 3. Fetch Trigger
    window.fetchData = function(type) {
        $.post(`/api/fetch/${type}`, function(res) {
            alert(res.message);
            table.ajax.reload(); // Refresh the table
            updateStats();      // Refresh the counters
        });
    };

    updateStats();
});
</script>
{% endblock %}